stages:
  - test
  - security
  - deploy

variables:
  POSTGRES_DB: test_db
  POSTGRES_USER: test_user
  POSTGRES_PASSWORD: test_password
  POSTGRES_HOST_AUTH_METHOD: trust
  # Configure postgres service to listen on all interfaces
  POSTGRES_HOST_AUTH_METHOD: trust
  
  # App config
  DB_HOST: postgres
  DB_PORT: 5432
  DB_USER: test_user
  DB_PASSWORD: test_password
  DB_NAME: test_db
  REDIS_HOST: redis
  REDIS_PORT: 6379
  SECRET_KEY: test_secret_key_for_ci
  PYTHONPATH: ${CI_PROJECT_DIR}/app
  # Ansible config
  ANSIBLE_HOST_KEY_CHECKING: "False"

.test-template:
  image: python:3.12
  services:
    - name: postgres:15
      alias: postgres
    - name: redis:7
      alias: redis
  before_script:
    - pip install -r app/requirements.txt
    - pip install pytest pytest-asyncio httpx pytest-cov freezegun asynctest bcrypt

run_tests:
  extends: .test-template
  stage: test
  script:
    - pytest -v --cov=app --cov-report=term app/tests
  coverage: '/TOTAL.*\s+(\d+%)$/'

security_scan:
  stage: security
  image: python:3.12
  script:
    - pip install bandit safety
    - bandit -r app/ -x app/tests/
    # - safety scan # Uncomment when ready, safety might require auth or be verbose

deploy:
  stage: deploy
  image: python:3.12
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  before_script:
    - apt-get update && apt-get install -y ansible
    - mkdir -p ~/.ssh
    - echo "$VPS_SSH_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
  script:
    # Replicate inventory creation from GitHub Actions
    - mkdir -p deployments/ansible
    - echo "[vps]" > deployments/ansible/inventory.ini
    - echo "server ansible_host=$VPS_HOST ansible_user=$VPS_USER ansible_ssh_private_key_file=~/.ssh/id_rsa" >> deployments/ansible/inventory.ini
    
    # Replicate Vault Secret creation
    - mkdir -p deployments/ansible/group_vars/all
    - |
      cat <<EOF > deployments/ansible/group_vars/all/env.yml
      db_user: "$DB_USER"
      db_password: "$DB_PASSWORD"
      db_name: "$DB_NAME"
      redis_password: "$REDIS_PASSWORD"
      minio_root_user: "$MINIO_ROOT_USER"
      minio_root_password: "$MINIO_ROOT_PASSWORD"
      EOF
    
    # Encrypt secrets
    - echo "$ANSIBLE_VAULT_PASSWORD" > vault_pass.txt
    - ansible-vault encrypt deployments/ansible/group_vars/all/env.yml --vault-password-file vault_pass.txt
    
    # Run Playbook
    - ansible-playbook -i deployments/ansible/inventory.ini deployments/ansible/playbook.yml --vault-password-file vault_pass.txt
  after_script:
    - rm -rf deployments/ansible/group_vars
    - rm -rf vault_pass.txt
    - rm -rf ~/.ssh/id_rsa
