---
# App role: Deploy main application stack

- name: Sync project files to VPS
  ansible.posix.synchronize:
    src: "{{ playbook_dir }}/../../"
    dest: /opt/places_backend
    delete: yes
    rsync_opts:
      - "--exclude=.git"
      - "--exclude=.venv"
      - "--exclude=.vagrant"
      - "--exclude=venv"
      - "--exclude=__pycache__"
      - "--exclude=*.pyc"
      - "--exclude=.pytest_cache"
      - "--exclude=.old"
      - "--exclude=.history"

- name: Create certificate directory
  file:
    path: "/opt/places_backend/data/certbot/conf/live/{{ domain_name }}"
    state: directory
    mode: '0755'
    recurse: yes
  vars:
    domain_name: "{{ domain }}"
  when: env_name != 'prod'

- name: Generate self-signed certificate if not exists
  command: >
    openssl req -x509 -nodes -days 365 -newkey rsa:2048
    -keyout /opt/places_backend/data/certbot/conf/live/{{ domain_name }}/privkey.pem
    -out /opt/places_backend/data/certbot/conf/live/{{ domain_name }}/fullchain.pem
    -subj "/C=US/ST=State/L=City/O=Organization/CN={{ domain_name }}"
  args:
    creates: "/opt/places_backend/data/certbot/conf/live/{{ domain_name }}/fullchain.pem"
  vars:
    domain_name: "{{ domain }}"
  when: env_name != 'prod'

- name: Create chain.pem (copy of fullchain)
  copy:
    src: "/opt/places_backend/data/certbot/conf/live/{{ domain_name }}/fullchain.pem"
    dest: "/opt/places_backend/data/certbot/conf/live/{{ domain_name }}/chain.pem"
    remote_src: yes
  vars:
    domain_name: "{{ domain }}"
  when: env_name != 'prod'

- name: Setup NGINX config from template
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /opt/places_backend/deployments/configs/nginx/nginx.conf
    owner: root
    group: root
    mode: "0644"
  vars:
    domain_name: "{{ domain }}"  # from vault
  
- name: Setup Internal NGINX config from template
  ansible.builtin.template:
    src: internal_nginx.conf.j2
    dest: /opt/places_backend/deployments/configs/nginx/internal_nginx.conf
    owner: root
    group: root
    mode: "0644"

- name: Setup .env file from template
  ansible.builtin.template:
    src: env.j2
    dest: /opt/places_backend/.env
    owner: root
    group: root
    mode: "0644"
  
- name: Run docker-compose for main application
  shell: |
    if [ "{{ env_name }}" = "prod" ]; then
      PROFILE_ARG="--profile prod"
    else
      PROFILE_ARG=""
    fi
    docker compose $PROFILE_ARG --profile portainer --env-file .env -f compose/docker-compose.yml up -d --build
  args:
    chdir: /opt/places_backend
  async: 600
  poll: 10
  environment:
    COMPOSE_HTTP_TIMEOUT: "300"
  # no_log: true
