---
# App role: Deploy main application stack

- name: Sync project files to VPS
  ansible.posix.synchronize:
    src: "{{ playbook_dir }}/../../"
    dest: /opt/places_backend
    delete: yes
    rsync_opts:
      - "--exclude=.git"
      - "--exclude=.venv"
      - "--exclude=.vagrant"
      - "--exclude=venv"
      - "--exclude=__pycache__"
      - "--exclude=*.pyc"
      - "--exclude=.pytest_cache"
      - "--exclude=.old"
      - "--exclude=.history"

- name: Create certificate directory
  file:
    path: "/opt/places_backend/data/certbot/conf/live/{{ domain_name }}"
    state: directory
    mode: '0755'
    recurse: yes
  vars:
    domain_name: "{{ domain }}"
  when: env_name != 'prod'

- name: Generate self-signed certificate if not exists
  command: >
    openssl req -x509 -nodes -days 365 -newkey rsa:2048
    -keyout /opt/places_backend/data/certbot/conf/live/{{ domain_name }}/privkey.pem
    -out /opt/places_backend/data/certbot/conf/live/{{ domain_name }}/fullchain.pem
    -subj "/C=US/ST=State/L=City/O=Organization/CN={{ domain_name }}"
  args:
    creates: "/opt/places_backend/data/certbot/conf/live/{{ domain_name }}/fullchain.pem"
  vars:
    domain_name: "{{ domain }}"
  when: env_name != 'prod'

- name: Create chain.pem (copy of fullchain)
  copy:
    src: "/opt/places_backend/data/certbot/conf/live/{{ domain_name }}/fullchain.pem"
    dest: "/opt/places_backend/data/certbot/conf/live/{{ domain_name }}/chain.pem"
    remote_src: yes
  vars:
    domain_name: "{{ domain }}"
  when: env_name != 'prod'

- name: Setup NGINX config from template
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /opt/places_backend/deployments/configs/nginx/nginx.conf
    owner: root
    group: root
    mode: "0644"
  vars:
    domain_name: "{{ domain }}"  # from vault
  
- name: Setup Internal NGINX config from template
  ansible.builtin.template:
    src: internal_nginx.conf.j2
    dest: /opt/places_backend/deployments/configs/nginx/internal_nginx.conf
    owner: root
    group: root
    mode: "0644"

- name: Ensure vault-agent config directory exists
  file:
    path: /opt/places_backend/deployments/configs/vault-agent
    state: directory
    mode: '0777'

- name: Provision role_id for Vault Agent
  copy:
    content: "{{ vault_role_id }}"
    dest: /opt/places_backend/deployments/configs/vault-agent/role_id
    mode: '0644'
  when: vault_role_id is defined

- name: Provision secret_id for Vault Agent
  copy:
    content: "{{ vault_secret_id }}"
    dest: /opt/places_backend/deployments/configs/vault-agent/secret_id
    mode: '0644'
  when: vault_secret_id is defined
  
  #TODO: supposed to be deleted
- name: Ensure .env file exists
  file:
    path: /opt/places_backend/.env
    state: touch
    mode: '0644'

- name: Start Vault Agent first
  shell: |
    VAULT_ADDR={{ vault_addr | default('http://host.docker.internal:8200') }} \
    docker compose -f compose/docker-compose.yml up -d --force-recreate vault-agent
  args:
    chdir: /opt/places_backend

- name: Wait for secrets.env generation by Vault Agent
  shell: |
    for i in $(seq 1 30); do
      if [ -s /opt/places_backend/deployments/configs/vault-agent/secrets.env ] && grep -q "DB_PASSWORD" /opt/places_backend/deployments/configs/vault-agent/secrets.env; then
        echo "secrets.env generated successfully"
        exit 0
      fi
      echo "Waiting for secrets.env... (attempt $i)"
      sleep 2
    done
    echo "Timeout waiting for secrets.env generation"
    exit 1
  args:
    executable: /bin/bash
    chdir: /opt/places_backend
  when: vault_role_id is defined

- name: Run docker-compose for main application
  shell: |
    if [ "{{ env_name }}" = "test" ] || [ "{{ env_name }}" = "prod" ]; then
        IMAGE_NAME="vurados/places-backend"
    fi
    IMAGE_TAG={{ app_image_tag | default('latest') }} \
    IMAGE_NAME=$IMAGE_NAME \
    VAULT_ADDR={{ vault_addr | default('http://host.docker.internal:8200') }} \
    docker compose --profile portainer --env-file .env -f compose/docker-compose.yml up -d
  args:
    chdir: /opt/places_backend
  environment:
    COMPOSE_HTTP_TIMEOUT: "1000"
