---
# Common role: Production server hardening and baseline configuration

- name: Update apt cache and upgrade system packages
  apt:
    update_cache: yes
    upgrade: dist
    cache_valid_time: 3600

- name: Install baseline utilities
  apt:
    name:
      - htop
      - curl
      - git
      - vim
      - ufw
      - fail2ban
      - software-properties-common
    state: present

- name: Set system timezone
  community.general.timezone:
    name: "{{ timezone | default('UTC') }}"

- name: Configure UFW (Firewall)
  block:
    - name: Allow SSH
      community.general.ufw:
        rule: allow
        name: OpenSSH

    - name: Allow HTTP
      community.general.ufw:
        rule: allow
        port: '80'
        proto: tcp

    - name: Allow HTTPS
      community.general.ufw:
        rule: allow
        port: '443'
        proto: tcp

    - name: Enable UFW
      community.general.ufw:
        state: enabled
        policy: deny

- name: Configure Fail2Ban
  block:
    - name: Ensure Fail2Ban is running
      service:
        name: fail2ban
        state: started
        enabled: yes

    - name: Create basic jail.local for SSH
      copy:
        content: |
          [sshd]
          enabled = true
          port = ssh
          filter = sshd
          logpath = /var/log/auth.log
          maxretry = 5
          bantime = 1h
        dest: /etc/fail2ban/jail.local
        owner: root
        group: root
        mode: '0644'
      notify: Restart fail2ban

- name: Disable Root Login via SSH (Hardening)
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^PermitRootLogin'
    line: 'PermitRootLogin no'
    state: present
  notify: Restart ssh
