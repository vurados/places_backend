---
# Deploy role: Deploy main application stack

- name: Create certificate directory
  file:
    path: "/opt/places_backend/data/certbot/conf/live/{{ domain_name }}"
    state: directory
    mode: '0755'
    recurse: yes
  vars:
    domain_name: "{{ domain }}"
  when: env_name != 'prod'

- name: Generate self-signed certificate if not exists
  command: >
    openssl req -x509 -nodes -days 365 -newkey rsa:2048
    -keyout /opt/places_backend/data/certbot/conf/live/{{ domain_name }}/privkey.pem
    -out /opt/places_backend/data/certbot/conf/live/{{ domain_name }}/fullchain.pem
    -subj "/C=US/ST=State/L=City/O=Organization/CN={{ domain_name }}"
  args:
    creates: "/opt/places_backend/data/certbot/conf/live/{{ domain_name }}/fullchain.pem"
  vars:
    domain_name: "{{ domain }}"
  when: env_name != 'prod'

- name: Create chain.pem (copy of fullchain)
  copy:
    src: "/opt/places_backend/data/certbot/conf/live/{{ domain_name }}/fullchain.pem"
    dest: "/opt/places_backend/data/certbot/conf/live/{{ domain_name }}/chain.pem"
    remote_src: yes
  vars:
    domain_name: "{{ domain }}"
  when: env_name != 'prod'

- name: Deploy NGINX config from template
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /opt/places_backend/deployments/nginx/nginx.conf
    owner: root
    group: root
    mode: "0644"
  vars:
    domain_name: "{{ domain }}"  # from vault
  
- name: Deploy Internal NGINX config from template
  ansible.builtin.template:
    src: internal_nginx.conf.j2
    dest: /opt/places_backend/deployments/nginx/internal_nginx.conf
    owner: root
    group: root
    mode: "0644"
  
- name: Run docker-compose for main application
  shell: |
    if [ "{{ env_name }}" = "prod" ]; then
      PROFILE_ARG="--profile prod"
    else
      PROFILE_ARG=""
    fi
    docker compose $PROFILE_ARG -f /opt/places_backend/docker-compose.yml up -d --build
  args:
    chdir: /opt/places_backend
  environment:
    DB_USER: "{{ db_user }}"
    DB_PASSWORD: "{{ db_password }}"
    DB_NAME: "{{ db_name }}"
    REDIS_PASSWORD: "{{ redis_password }}"
    MINIO_ROOT_USER: "{{ minio_root_user }}"
    MINIO_ROOT_PASSWORD: "{{ minio_root_password }}"
    SECRET_KEY: "{{ secret_key | default('test_secret_key_change_in_production') }}"
  no_log: true
